<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách học viên</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .navbar-brand { font-weight: bold; }
        .nav-link { color: #6c757d !important; }
        .nav-link.active { color: #0d6efd !important; }
        .dropdown-menu { min-width: 200px; }
    </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <a class="navbar-brand" href="#">Hệ thống quản lý trung tâm đào tạo</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/dashboard/nhanvien">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/ctdt/list">Chương trình đào tạo</a></li>
            <li class="nav-item"><a class="nav-link" href="/giang-vien/list">Giảng viên</a></li>
            <li class="nav-item"><a class="nav-link" href="/diem-thi/list">Điểm thi</a></li>
            <li class="nav-item"><a class="nav-link" href="/luong/list">Lương</a></li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                    <span th:text="${sessionService.getCurrentUser().loaiTaiKhoan} ?: 'Nhân viên'"></span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="/profile">Hồ sơ</a></li>
                    <li><a class="dropdown-item" href="/logout">Đăng xuất</a></li>
                </ul>
            </li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <div class="d-flex align-items-center mb-3">
        <div><h3 class="mb-0">Danh sách học viên của lớp</h3></div>
        <div class="ms-auto" th:if="${sessionService.getCurrentUser().loaiTaiKhoan == 'NhanVien'}">
            <a th:href="@{/diem-thi/lopHocPhan_list}" class="btn btn-outline-secondary">Quay về danh sách</a>
        </div>
    </div>

    <!-- Form tìm kiếm -->
    <form th:action="@{/lopHocPhan/nhap}" method="get" class="row g-2 mb-3">
        <input type="hidden" name="maLHP" th:value="${maLHP}"/>
        <div class="col-auto">
            <select name="maSV" class="form-select">
                <option value="">-- Chọn sinh viên --</option>
                <option th:each="entry : ${HocVienMap}"
                        th:value="${entry.key}"
                        th:text="${entry.value}"
                        th:selected="${entry.key == maSV}"></option>
            </select>
        </div>
        <div class="col-auto">
            <input type="text" name="keyword" th:value="${keyword}" placeholder="Tên sinh viên" class="form-control"/>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </div>
    </form>

    <!-- Bảng danh sách -->
    <table class="table table-bordered table-hover">
        <thead class="table-light">
        <tr>
            <th>STT</th>
            <th>Mã SV</th>
            <th>Họ Tên</th>
            <th>Chuyên Ngành</th>
            <th>Khóa</th>
            <th>Đã có điểm</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="sv, iterStat : ${dsHocVien}">
            <td th:text="${iterStat.count}"></td>
            <td th:text="${sv.MaSV}"></td>
            <td th:text="${sv.HoTen}"></td>
            <td th:text="${sv.TenCN}"></td>
            <td th:text="${sv.NamHoc}"></td>
            <td th:text="${sv.DaCoDiem == 1 ? 'Có' : 'Chưa'}"></td>
            <td>
                <button type="button"
                        th:classappend="${sv.DaCoDiem == 1} ? ' btn btn-warning btn-sm' : ' btn btn-success btn-sm'"
                        th:text="${sv.DaCoDiem == 1} ? 'Sửa điểm' : 'Nhập điểm'"
                        th:attr="data-bs-toggle='modal', data-bs-target='#diemModal',
                                 data-masv=${sv.MaSV},
                                 data-tensv=${sv.HoTen},
                                 data-mahp=${sv.MaHP},
                                 data-tenhp=${sv.TenHP},
                                 data-lanthi=${sv.LanThi},
                                 data-diemcc=${sv.DiemCC != null ? sv.DiemCC : ''},
                                 data-diemgk=${sv.DiemGK != null ? sv.DiemGK : ''},
                                 data-diemck=${sv.DiemCK != null ? sv.DiemCK : ''}">
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal nhập/sửa điểm -->
<div class="modal fade" id="diemModal" tabindex="-1" aria-labelledby="diemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="diemModalLabel">Nhập/Sửa điểm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalMaSV"/>
                <input type="hidden" id="modalMaHP"/>
                <input type="hidden" id="modalLanThi"/>

                <div class="mb-3">
                    <label class="form-label">Học phần</label>
                    <input type="text" class="form-control" id="modalTenHP" readonly/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Sinh viên</label>
                    <input type="text" class="form-control" id="modalTenSV" readonly/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Điểm chuyên cần</label>
                    <input type="number" step="0.1" min="0" max="10" class="form-control" id="modalDiemCC"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Điểm giữa kỳ</label>
                    <input type="number" step="0.1" min="0" max="10" class="form-control" id="modalDiemGK"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Điểm cuối kỳ</label>
                    <input type="number" step="0.1" min="0" max="10" class="form-control" id="modalDiemCK"/>
                </div>
                <div id="modalAlert" class="alert d-none" role="alert"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="btnSaveDiem" class="btn btn-primary">Lưu</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Script gán dữ liệu modal và gọi API -->
<script th:inline="javascript">
    /*<![CDATA[*/
    var diemModalEl = document.getElementById('diemModal');
    diemModalEl.addEventListener('show.bs.modal', function(event) {
        var button = event.relatedTarget;

        var maSV = button.getAttribute('data-masv');
        var tenSV = button.getAttribute('data-tensv');
        var maHP = button.getAttribute('data-mahp');
        var tenHP = button.getAttribute('data-tenhp');
        var diemCC = button.getAttribute('data-diemcc');
        var diemGK = button.getAttribute('data-diemgk');
        var diemCK = button.getAttribute('data-diemck');
        var lanThi = button.getAttribute('data-lanthi');

        document.getElementById('modalMaSV').value = maSV;
        document.getElementById('modalTenSV').value = tenSV;
        document.getElementById('modalMaHP').value = maHP;
        document.getElementById('modalTenHP').value = tenHP;
        document.getElementById('modalLanThi').value = lanThi;
        document.getElementById('modalDiemCC').value = (diemCC && diemCC != '0') ? diemCC : '';
        document.getElementById('modalDiemGK').value = (diemGK && diemGK != '0') ? diemGK : '';
        document.getElementById('modalDiemCK').value = (diemCK && diemCK != '0') ? diemCK : '';

        console.log('lanThi: ', lanThi)
        // Reset alert
        var alertEl = document.getElementById('modalAlert');
        alertEl.classList.add('d-none');
        alertEl.innerText = '';
    });

    document.getElementById('btnSaveDiem').addEventListener('click', function() {
        var maSV = document.getElementById('modalMaSV').value;
        var maHP = document.getElementById('modalMaHP').value;
        var lanThi = document.getElementById('modalLanThi').value;
        var diemCC = document.getElementById('modalDiemCC').value;
        var diemGK = document.getElementById('modalDiemGK').value;
        var diemCK = document.getElementById('modalDiemCK').value;
        console.log('lanThibtn: ', lanThi)
        var url = (!lanThi || lanThi.trim() === '') ? '/api/ketQua/them' : '/api/ketQua/sua';

        var payload = {
            maSV: maSV,
            maHP: maHP,
            lanThi: lanThi,
            diemCC: diemCC ? parseFloat(diemCC) : null,
            diemGK: diemGK ? parseFloat(diemGK) : null,
            diemCK: diemCK ? parseFloat(diemCK) : null
        };

        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
            .then(response => response.json())
            .then(data => {
                var alertEl = document.getElementById('modalAlert');
                if (data.status === 'success') {
                    alertEl.className = 'alert alert-success';
                    alertEl.innerText = data.message;
                    // Optional: reload page or refresh table
                    setTimeout(function() { location.reload(); }, 1000);
                } else {
                    alertEl.className = 'alert alert-danger';
                    alertEl.innerText = data.message;
                }
                alertEl.classList.remove('d-none');
            })
            .catch(err => {
                var alertEl = document.getElementById('modalAlert');
                alertEl.className = 'alert alert-danger';
                alertEl.innerText = 'Lỗi khi gọi API: ' + err;
                alertEl.classList.remove('d-none');
            });
    });
    /*]]>*/
</script>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



</body>
</html>

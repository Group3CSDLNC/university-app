<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Học phần</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <style>
        .search-add-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; }
        .loading { display: none; text-align: center; color: #6c757d; margin-bottom: 10px; }
    </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <a class="navbar-brand" href="#">Hệ thống quản lý trung tâm đào tạo</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="/ctdt/list">Chương trình đào tạo</a></li>
            <li th:if="${sessionService.currentUser != null and sessionService.currentUser.loaiTaiKhoan == 'Admin'}" class="nav-item">
                <a class="nav-link" href="/khoa/list">Khoa</a>
            </li>
            <li class="nav-item active" th:if="${sessionService.currentUser != null and (sessionService.currentUser.loaiTaiKhoan == 'Admin' or sessionService.currentUser.loaiTaiKhoan == 'QuanLy')}">
                <a class="nav-link" href="/hocPhan/hocphan_list">Học phần</a>
            </li>
            <li th:if="${sessionService.currentUser != null and (sessionService.currentUser.loaiTaiKhoan == 'Admin' or sessionService.currentUser.loaiTaiKhoan == 'QuanLy')}" class="nav-item">
                <a class="nav-link" href="/hoc-vien/list">Học viên</a>
            </li>
            <li th:if="${sessionService.currentUser != null and sessionService.currentUser.loaiTaiKhoan == 'Admin'}" class="nav-item">
                <a class="nav-link" href="/nhan-vien/list">Nhân viên</a>
            </li>
            <li th:if="${sessionService.currentUser != null and sessionService.currentUser.loaiTaiKhoan == 'GiangVien'}" class="nav-item">
                <a class="nav-link" href="/giang-vien/list">Giảng viên</a>
            </li>
            <li th:if="${sessionService.currentUser != null and sessionService.currentUser.loaiTaiKhoan == 'SinhVien'}" class="nav-item">
                <a class="nav-link" href="/khoa/list">Khoa</a>
            </li>
            <li th:if="${sessionService.currentUser != null and (sessionService.currentUser.loaiTaiKhoan == 'GiangVien' or sessionService.currentUser.loaiTaiKhoan == 'SinhVien')}" class="nav-item">
                <a class="nav-link" href="/diem-thi/list">Điểm thi</a>
            </li>
            <li th:if="${sessionService.currentUser != null and sessionService.currentUser.loaiTaiKhoan == 'GiangVien'}" class="nav-item">
                <a class="nav-link" href="/luong/list">Lương</a>
            </li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                    <span id="userName" th:text="${sessionService.currentUser != null ? sessionService.currentUser.tenDangNhap : ''}"></span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="/profile">Hồ sơ</a>
                    <a class="dropdown-item" href="/logout">Đăng xuất</a>
                </div>
            </li>
        </ul>
    </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
    <h2>Danh sách Học phần</h2>

    <!-- Search + Add -->
    <form id="searchForm" class="d-flex w-100">
        <input type="text" id="keyword" placeholder="Tìm theo tên học phần"
               class="form-control search-input" th:value="${keyword}">
        <button type="button" class="btn btn-outline-secondary" onclick="searchHP()">Tìm</button>
        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#hocPhanModal">Thêm Học phần</button>
    </form>

    <div id="loading" class="loading">Đang tải...</div>

    <!-- Table -->
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Mã HP</th>
            <th>Tên học phần</th>
            <th>Tín chỉ</th>
            <th>Số tiết thực hành</th>
            <th>Số tiết lý thuyết</th>
            <th>Chương trình đào tạo</th>
            <th>Môn tiên quyết</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="hp : ${hocphans}">
            <td th:text="${hp.maHP}"></td>
            <td th:text="${hp.tenHP}"></td>
            <td th:text="${hp.soTinChi}"></td>
            <td th:text="${hp.tietTH}"></td>
            <td th:text="${hp.tietLT}"></td>
            <td th:text="${ctdtMap[hp.maCTDT]}"></td>
            <td>
                <span th:text="${hp.tienQuyet != null ? hocphanMap[hp.tienQuyet] : ''}"></span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary btnEdit" th:data-id="${hp.maHP}">Sửa</button>
                <button class="btn btn-sm btn-danger btnDelete" th:data-id="${hp.maHP}">Xóa</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Form modal thêm/sửa -->
<div class="modal" tabindex="-1" role="dialog" id="hocphanModal">
    <div class="modal-dialog" role="document">
        <div class="modal-content p-3">
            <h5 class="modal-title mb-3">Học phần</h5>
            <form id="hocphanForm">
                <input type="hidden" name="maHP" id="maHP">
                <div class="form-group">
                    <label>Tên học phần</label>
                    <input type="text" name="tenHP" id="tenHP" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Số tín chỉ</label>
                    <input type="number" name="soTinChi" id="soTinChi" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Số tiết thực hành</label>
                    <input type="number" name="tietTH" id="tietTH" class="form-control">
                </div>
                <div class="form-group">
                    <label>Số tiết lý thuyết</label>
                    <input type="number" name="tietLT" id="tietLT" class="form-control">
                </div>
                <div class="form-group">
                    <label>Chương trình đào tạo</label>
                    <select name="maCTDT" id="maCTDT" class="form-control" required>
                        <option value="">-- Chọn CTDT --</option>
                        <option th:each="ct : ${ctdts}"
                                th:value="${ct.maCTDT}"
                                th:text="${ct.tenCTDT}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Môn tiên quyết</label>
                    <select name="tienQuyet" id="tienQuyet" class="form-control">
                        <option value="0">Không có</option>
                        <option th:each="hpSel : ${hocphans}"
                                th:value="${hpSel.maHP}"
                                th:text="${hpSel.tenHP}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Lưu</button>
                <button type="button" class="btn btn-secondary" id="btnClose">Đóng</button>
            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script>
    const hocphanModal = document.getElementById("hocphanModal");
    const hocphanForm = document.getElementById("hocphanForm");

    document.getElementById("btnAdd").addEventListener("click", () => {
        hocphanForm.reset();
        document.getElementById("maHP").value = "";
        hocphanModal.style.display = "block";
    });

    document.getElementById("btnClose").addEventListener("click", () => {
        hocphanModal.style.display = "none";
    });

    // Submit form thêm/sửa (AJAX)
    hocphanForm.addEventListener("submit", function(e){
        e.preventDefault();
        const formData = new FormData(hocphanForm);
        fetch("/api/hocPhan/save", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(Object.fromEntries(formData))
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message); // thông báo FE
                location.reload();
            })
            .catch(err => alert(err.message));
    });

    function searchHP() {
        const keyword = document.getElementById("keyword").value;
        fetch(`/api/hocPhan/search?keyword=${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("table tbody");
                tbody.innerHTML = "";
                data.forEach(hp => {
                    tbody.innerHTML += `
                    <tr>
                        <td>${hp.maHP}</td>
                        <td>${hp.tenHP}</td>
                        <td>${hp.soTinChi}</td>
                        <td>${hp.tietTH}</td>
                        <td>${hp.tietLT}</td>
                        <td>${hp.tenCTDT || ""}</td>
                        <td>${hp.tenTienQuyet || ""}</td>
                        <td>
                            <button class="btn btn-sm btn-primary btnEdit" data-id="${hp.maHP}">Sửa</button>
                            <button class="btn btn-sm btn-danger btnDelete" data-id="${hp.maHP}">Xóa</button>
                        </td>
                    </tr>
                `;
                });
            })
            .catch(err => alert("Lỗi khi tìm kiếm: " + err));
    }

    // Sửa học phần
    document.querySelectorAll(".btnEdit").forEach(btn => {
        btn.addEventListener("click", function() {
            const maHP = this.getAttribute("data-id");
            fetch(`/api/hocPhan/${maHP}`)
                .then(res => res.json())
                .then(hp => {
                    document.getElementById("maHP").value = hp.maHP;
                    document.getElementById("tenHP").value = hp.tenHP;
                    document.getElementById("soTinChi").value = hp.soTinChi;
                    document.getElementById("tietTH").value = hp.tietTH;
                    document.getElementById("tietLT").value = hp.tietLT;
                    document.getElementById("maCTDT").value = hp.maCTDT;
                    document.getElementById("tienQuyet").value = hp.tienQuyet || 0;
                    hocphanModal.style.display = "block";
                });
        });
    });

    // Xóa
    document.querySelectorAll(".btnDelete").forEach(btn => {
        btn.addEventListener("click", function() {
            if (!confirm("Bạn có chắc muốn xóa học phần này?")) return;
            const maHP = this.getAttribute("data-id");
            fetch(`/api/hocPhan/delete/${maHP}`, { method: "DELETE" })
                .then(res => res.json())
                .then(data => {
                    alert(data.message); // hiển thị message ngắn gọn
                    if(res.ok) this.closest("tr").remove();
                })
        });
    });
</script>

</body>
</html>

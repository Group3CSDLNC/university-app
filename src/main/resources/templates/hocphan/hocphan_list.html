<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách Học phần</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <style>
        .search-add-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-input { flex: 1; }
        .loading { display: none; text-align: center; color: #6c757d; margin-bottom: 10px; }
    </style>
</head>
<body>

<!-- Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <a class="navbar-brand" href="#">Hệ thống quản lý trung tâm đào tạo</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="/dashboard/admin">Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/ctdt/list">Chương trình đào tạo</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/khoa/list">Khoa</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/hocPhan/hocphan_list">Học phần</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/lopHocPhan/lopHocPhan_list">Lớp Học phần</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/hoc-vien/list">Học viên</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/nhan-vien/list">Nhân viên</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/giang-vien/list">Giảng viên</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/phong-hoc/list">Phòng học</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/diem-thi/list">Điểm thi</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/luong/list">Lương</a>
            </li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                    <span th:text="${session.userName} ?: 'Admin'"></span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="/profile">Hồ sơ</a>
                    <a class="dropdown-item" href="/logout">Đăng xuất</a>
                </div>
            </li>
        </ul>
    </div>
</nav>
<!-- Main Content -->
<div class="container mt-4">
    <h2>Danh sách Học phần</h2>

    <!-- Search + Add -->
    <div class="search-add-group mb-3">
        <input type="text" id="keyword" class="form-control search-input" placeholder="Tìm kiếm theo tên học phần">
        <button class="btn btn-outline-secondary" onclick="searchHP()">Tìm</button>
        <button class="btn btn-success" data-toggle="modal" data-target="#hocphanModal" onclick="openAddModal()">Thêm Học phần</button>
    </div>

    <div id="loading" class="loading">Đang tải...</div>

    <!-- Table -->
    <table class="table table-striped" id="hocphanTable">
        <thead>
        <tr>
            <th>Mã HP</th>
            <th>Tên học phần</th>
            <th>Tín chỉ</th>
            <th>Số tiết thực hành</th>
            <th>Số tiết lý thuyết</th>
            <th>Chương trình đào tạo</th>
            <th>Môn tiên quyết</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody id="hocphanTableBody">
        <tr th:each="hp : ${hocphans}">
            <td th:text="${hp.maHP}"></td>
            <td th:text="${hp.tenHP}"></td>
            <td th:text="${hp.soTinChi}"></td>
            <td th:text="${hp.tietTH}"></td>
            <td th:text="${hp.tietLT}"></td>
            <td th:text="${ctdtMap[hp.maCTDT]}"></td>
            <td>
                <span th:text="${hp.tienQuyet != null ? hocphanMap[hp.tienQuyet] : ''}"></span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary btnEdit" th:data-id="${hp.maHP}">Sửa</button>
                <button class="btn btn-sm btn-danger btnDelete" th:data-id="${hp.maHP}">Xóa</button>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="hocphanModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content p-3">
            <h5 class="modal-title mb-3">Học phần</h5>
            <form id="hocphanForm">
                <input type="hidden" id="maHP">
                <div class="form-group">
                    <label>Tên học phần</label>
                    <input type="text" id="tenHP" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Số tín chỉ</label>
                    <input type="number" id="soTinChi" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Số tiết thực hành</label>
                    <input type="number" id="tietTH" class="form-control">
                </div>
                <div class="form-group">
                    <label>Số tiết lý thuyết</label>
                    <input type="number" id="tietLT" class="form-control">
                </div>
                <div class="form-group">
                    <label>Chương trình đào tạo</label>
                    <select name="maCTDT" id="maCTDT" class="form-control" required>
                        <option value="">-- Chọn CTDT --</option>
                        <option th:each="ct : ${ctdts}"
                                th:value="${ct.maCTDT}"
                                th:text="${ct.tenCTDT}">
                        </option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Môn tiên quyết</label>
                    <select name="tienQuyet" id="tienQuyet" class="form-control">
                        <option value="0">Không có</option>
                        <option th:each="hpSel : ${hocphans}"
                                th:value="${hpSel.maHP}"
                                th:text="${hpSel.tenHP}"></option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Lưu</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </form>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const loading = document.getElementById("loading");
    const tbody = document.getElementById("hocphanTableBody");
    const ctdtMap = /*[[${ctdtMap}]]*/ {};
    const hocphanMap = /*[[${hocphanMap}]]*/ {};

    function searchHP() {
        const keyword = document.getElementById("keyword").value;
        loading.style.display = "block";
        fetch(`/api/hocPhan/search?keyword=${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => {
                tbody.innerHTML = "";
                data.forEach(hp => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${hp.maHP}</td>
                            <td>${hp.tenHP}</td>
                            <td>${hp.soTinChi}</td>
                            <td>${hp.tietTH}</td>
                            <td>${hp.tietLT}</td>
                            <td>${ctdtMap[hp.maCTDT] || ""}</td>
                            <td>${hocphanMap[hp.tienQuyet] || ""}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="openEditModal(${hp.maHP})">Sửa</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteHP(${hp.maHP})">Xóa</button>
                            </td>
                        </tr>
                    `;
                });
            })
            .catch(err => alert("Lỗi: " + err.message))
            .finally(() => { loading.style.display = "none"; });
    }

    function openAddModal() {
        document.getElementById("hocphanForm").reset();
        document.getElementById("maHP").value = "";
    }

    function openEditModal(maHP) {
        fetch(`/api/hocPhan/${maHP}`)
            .then(res => res.json())
            .then(hp => {
                document.getElementById("maHP").value = hp.maHP;
                document.getElementById("tenHP").value = hp.tenHP;
                document.getElementById("soTinChi").value = hp.soTinChi;
                document.getElementById("tietTH").value = hp.tietTH;
                document.getElementById("tietLT").value = hp.tietLT;
                document.getElementById("maCTDT").value = hp.maCTDT;
                document.getElementById("tienQuyet").value = hp.tienQuyet || 0;
                $('#hocphanModal').modal('show');
            });
    }

    function deleteHP(maHP) {
        if (!confirm("Bạn có chắc muốn xóa học phần này?")) return;
        fetch(`/api/hocPhan/delete/${maHP}`, { method: "DELETE" })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                searchHP();
            });
    }

    document.getElementById("hocphanForm").addEventListener("submit", function(e){
        e.preventDefault();
        const hocphan = {
            maHP: document.getElementById("maHP").value,
            tenHP: document.getElementById("tenHP").value,
            soTinChi: document.getElementById("soTinChi").value,
            tietTH: document.getElementById("tietTH").value,
            tietLT: document.getElementById("tietLT").value,
            maCTDT: document.getElementById("maCTDT").value,
            tienQuyet: document.getElementById("tienQuyet").value === "0" ? null : document.getElementById("tienQuyet").value
        };
        fetch("/api/hocPhan/save", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(hocphan)
        })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                $('#hocphanModal').modal('hide');
                searchHP();
            });
    });

    // Load danh sách khi vào trang
    window.onload = searchHP;
</script>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

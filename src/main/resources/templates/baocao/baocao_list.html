<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Báo cáo</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"/>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <a class="navbar-brand" href="#">Hệ thống quản lý</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item active"><a class="nav-link" href="/bao-cao/list">Báo cáo</a></li>
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item"><span class="nav-link" th:text="${sessionService.getCurrentUser()?.loaiTaiKhoan} ?: 'Guest'"></span></li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <h3>Báo cáo</h3>

    <form method="get" action="#" th:action="@{/bao-cao/list}" class="form-inline mb-3">
        <label class="mr-2">Loại báo cáo:</label>
        <select name="reportType" class="form-control mr-3">
            <option th:value="'bangdiem'" th:selected="${reportType == 'bangdiem'}">Bảng điểm sinh viên</option>
            <option th:value="'chua-hoanthanh'" th:selected="${reportType == 'chua-hoanthanh'}">Sinh viên chưa hoàn thành khóa</option>
            <option th:value="'siso'" th:selected="${reportType == 'siso'}">Báo cáo sĩ số</option>
        </select>

        <label class="mr-2">CTĐT:</label>
        <select name="maCTDT" class="form-control mr-3">
            <option value="">-- Tất cả --</option>
            <option th:each="c : ${ctdtList}" th:value="${c.maCTDT}" th:text="${c.tenCTDT}" th:selected="${maCTDT != null and maCTDT.equals(c.maCTDT)}">"></option>
        </select>

        <label class="mr-2">Mã SV:</label>
        <input type="text" name="maSV" class="form-control mr-3" th:value="${maSV}"/>

        <button type="submit" class="btn btn-primary">Xem</button>
    </form>

    <div th:if="${reportData == null}">
        <div class="alert alert-info">Chọn loại báo cáo và nhấn "Xem".</div>
    </div>

    <!-- Bảng kết quả: render khác nhau tùy reportType -->
    <div th:if="${reportData != null}">
        <h5 th:text="${reportTitle}"></h5>

        <!-- Bảng điểm -->
        <table class="table table-bordered table-sm" th:if="${reportType == 'bangdiem'}">
            <thead>
            <tr>
                <th>Mã SV</th><th>Họ tên</th><th>Mã HP</th><th>Tên HP</th>
                <th>CTĐT</th><th>Năm học</th><th>Lần thi</th>
                <th>Điểm CC</th><th>Điểm GK</th><th>Điểm CK</th><th>Tổng kết</th><th>Trạng thái</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${reportData}">
                <td th:text="${r['MaSV']}"></td>
                <td th:text="${r['HoTen']}"></td>
                <td th:text="${r['MaHP']}"></td>
                <td th:text="${r['TenHP']}"></td>
                <td th:text="${r['TenCTDT']}"></td>
                <td th:text="${r['NamHoc']}"></td>
                <td th:text="${r['LanThi']}"></td>
                <td th:text="${r['DiemCC']}"></td>
                <td th:text="${r['DiemGK']}"></td>
                <td th:text="${r['DiemCK']}"></td>
                <td th:text="${#numbers.formatDecimal(r['TongKet'], 0, 2, 'POINT')}"></td>
                <td th:text="${r['TrangThai']}"></td>
            </tr>
            </tbody>
        </table>

        <!-- Sinh viên chưa hoàn thành -->
        <table class="table table-bordered table-sm" th:if="${reportType == 'chua-hoanthanh'}">
            <thead>
            <tr>
                <th>Mã SV</th>
                <th>Họ tên</th>
                <th>CTĐT</th>
                <th>Năm học</th>
                <th>Mã HP</th>
                <th>Tên HP</th>
                <th>Lần thi</th>
                <th>Điểm CC</th>
                <th>Điểm GK</th>
                <th>Điểm CK</th>
                <th>Tổng kết</th>
                <th>Trạng thái</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="r : ${reportData}">
                <td th:text="${r['MaSV']}"></td>
                <td th:text="${r['HoTen']}"></td>
                <td th:text="${r['TenCTDT']}"></td>
                <td th:text="${r['NamHoc']}"></td>
                <td th:text="${r['MaHP']}"></td>
                <td th:text="${r['TenHP']}"></td>
                <td th:text="${r['LanThi']}"></td>
                <td th:text="${r['DiemCC']}"></td>
                <td th:text="${r['DiemGK']}"></td>
                <td th:text="${r['DiemCK']}"></td>
                <td th:text="${#numbers.formatDecimal(r['TongKet'], 0, 2, 'POINT')}"></td>
                <td th:text="${r['TrangThai']}"></td>
            </tr>
            </tbody>
        </table>

        <div th:if="${#lists.isEmpty(reportData)}" class="alert alert-warning">Không có dữ liệu cho báo cáo này.</div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

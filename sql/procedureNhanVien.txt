CREATE OR ALTER PROCEDURE sp_GetAllNhanVien
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM NhanVien;
END;

CREATE OR ALTER PROCEDURE sp_GetNhanVienById
    @MaNV INT
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM NhanVien WHERE MaNV = @MaNV;
END;

CREATE OR ALTER PROCEDURE sp_ThemNhanVien
    @HoTen NVARCHAR(100),
    @HocVi NVARCHAR(30),
    @VaiTro NVARCHAR(50),
    @Email NVARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM NhanVien WHERE Email = @Email)
        THROW 72001, 'Email nhân viên đã tồn tại', 1;

    INSERT INTO NhanVien (HoTen, HocVi, VaiTro, Email)
    VALUES (@HoTen, @HocVi, @VaiTro, @Email);
END;


CREATE OR ALTER PROCEDURE sp_SuaNhanVien
    @MaNV INT,
    @HoTen NVARCHAR(100),
    @HocVi NVARCHAR(30),
    @VaiTro NVARCHAR(50),
    @Email NVARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM NhanVien WHERE MaNV = @MaNV)
        THROW 72002, 'Nhân viên không tồn tại', 1;

    IF EXISTS (SELECT 1 FROM NhanVien WHERE Email = @Email AND MaNV <> @MaNV)
        THROW 72001, 'Email nhân viên đã tồn tại', 1;

    UPDATE NhanVien
    SET HoTen = @HoTen,
        HocVi = @HocVi,
        VaiTro = @VaiTro,
        Email = @Email
    WHERE MaNV = @MaNV;
END;

CREATE OR ALTER PROCEDURE sp_XoaNhanVien
    @MaNV INT
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM NhanVien WHERE MaNV = @MaNV)
        THROW 72002, 'Nhân viên không tồn tại', 1;

    IF EXISTS (SELECT 1 FROM NhanVien_QuanLy WHERE MaNV_QuanLy = @MaNV)
        THROW 72003, 'Không thể xóa, nhân viên đang quản lý người khác', 1;

    IF EXISTS (SELECT 1 FROM CTDT_NhanVien WHERE MaNV = @MaNV)
        THROW 72004, 'Không thể xóa, nhân viên đang quản lý CTDT', 1;

    DELETE FROM NhanVien WHERE MaNV = @MaNV;
END;

CREATE OR ALTER PROCEDURE sp_GetNhanVienByVaiTroList
    @VaiTroList NVARCHAR(MAX)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT *
    FROM NhanVien
    WHERE ',' + @VaiTroList + ',' LIKE '%,' + VaiTro + ',%';
END

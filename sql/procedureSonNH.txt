/* ===========================
   PROCEDURES - ĐÃ SỬA
   - Chuẩn hóa kiểu tham số (BIGINT/INT)
   - Sửa logic kiểm tra xung đột (dựa trên TietBatDau & SoTiet)
   - Tự sinh MaCTDT, MaHP khi cần theo quy tắc:
       MaCTDT = MaCN * 100 + (right(left(NamHoc,4),2))
       MaHP   = MaCTDT * 100 + seq (lấy max seq hiện có + 1)
   - ROUND tính điểm và cập nhật KetQuaTongKet
   =========================== */

GO

-- 1) Thêm chương trinh (tự sinh MaCTDT từ MaCN + NamHoc)
CREATE OR ALTER PROCEDURE sp_AddChuongTrinh
    @TenCTDT NVARCHAR(150),
    @TongTinChi INT,
    @MaCN BIGINT,
    @NamHoc NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    -- Lấy 4 ký tự đầu (năm bắt đầu), sau đó lấy 2 số cuối
    DECLARE @year4 NVARCHAR(4) = LEFT(ISNULL(@NamHoc,''),4);
    DECLARE @yearSuffix INT =
        CASE
            WHEN TRY_CAST(RIGHT(@year4,2) AS INT) IS NOT NULL THEN TRY_CAST(RIGHT(@year4,2) AS INT)
            ELSE DATEPART(YEAR, GETDATE()) % 100
        END;

    DECLARE @MaCTDT BIGINT = @MaCN * 100 + @yearSuffix;

    -- Kiểm tra tồn tại
    IF EXISTS(SELECT 1 FROM ChuongTrinhDaoTao WHERE MaCTDT = @MaCTDT)
    BEGIN
        RAISERROR('CTDT da ton tai cho chuyen nganh va nam hoc.',16,1);
        RETURN;
    END

    INSERT INTO ChuongTrinhDaoTao (MaCTDT, TenCTDT, TongTinChi, MaCN, NamHoc)
    VALUES (@MaCTDT, @TenCTDT, @TongTinChi, @MaCN, @NamHoc);
END;
GO

-- 2) Cập nhật chương trình (MaCTDT là BIGINT)
CREATE OR ALTER PROCEDURE sp_UpdateChuongTrinh
    @MaCTDT BIGINT,
    @TenCTDT NVARCHAR(150),
    @TongTinChi INT,
    @MaCN BIGINT,
    @NamHoc NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    UPDATE ChuongTrinhDaoTao
    SET TenCTDT = @TenCTDT,
        TongTinChi = @TongTinChi,
        MaCN = @MaCN,
        NamHoc = @NamHoc
    WHERE MaCTDT = @MaCTDT;
END;
GO

-- 3) Xóa chương trình (kiểm tra ràng buộc)
CREATE OR ALTER PROCEDURE sp_DeleteChuongTrinh
    @MaCTDT BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT = @MaCTDT)
       OR EXISTS (
           SELECT 1
           FROM LopHocPhan LHP
           JOIN HocPhan HP ON LHP.MaHP = HP.MaHP
           WHERE HP.MaCTDT = @MaCTDT
       )
    BEGIN
        RAISERROR('Khong the xoa CTDT vi ton tai hoc phan hoac lop hoc phan lien quan.',16,1);
        RETURN;
    END

    DELETE FROM ChuongTrinhDaoTao WHERE MaCTDT = @MaCTDT;
END;
GO

-- 4) Gán nhân viên quản lý CTDT (MaCTDT BIGINT)
CREATE OR ALTER PROCEDURE sp_AssignNVQuanLyCTDT
    @MaCTDT BIGINT,
    @MaNV INT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM CTDT_NhanVien WHERE MaCTDT = @MaCTDT)
        UPDATE CTDT_NhanVien SET MaNV = @MaNV WHERE MaCTDT = @MaCTDT;
    ELSE
        INSERT INTO CTDT_NhanVien (MaCTDT, MaNV) VALUES (@MaCTDT, @MaNV);
END;
GO

-- 5) Danh sach + filter CTDT
CREATE OR ALTER PROCEDURE sp_ListCTDT
    @MaKhoa INT = NULL,
    @NamHoc NVARCHAR(50) = NULL,
    @MaNVQuanLy INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        ctdt.MaCTDT,
        ctdt.TenCTDT,
        ctdt.TongTinChi,
        ctdt.MaCN,
        cn.TenCN,
        k.MaKhoa,
        k.TenKhoa,
        ctdt.NamHoc,
        nv.MaNV AS NguoiQuanLy,
        nv.HoTen AS TenNguoiQuanLy
    FROM ChuongTrinhDaoTao ctdt
    INNER JOIN ChuyenNganh cn ON ctdt.MaCN = cn.MaCN
    INNER JOIN Khoa k ON cn.MaKhoa = k.MaKhoa
    LEFT JOIN CTDT_NhanVien ctdt_nv ON ctdt.MaCTDT = ctdt_nv.MaCTDT
    LEFT JOIN NhanVien nv ON ctdt_nv.MaNV = nv.MaNV
    WHERE
        (@MaKhoa IS NULL OR k.MaKhoa = @MaKhoa)
        AND (@NamHoc IS NULL OR ctdt.NamHoc = @NamHoc)
        AND (@MaNVQuanLy IS NULL OR nv.MaNV = @MaNVQuanLy)
    ORDER BY ctdt.MaCTDT DESC, k.TenKhoa, cn.TenCN;
END;
GO

-- 6) Search CTDT theo keyword
CREATE OR ALTER PROCEDURE sp_SearchCTDT
    @Keyword NVARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaCTDT, TenCTDT, TongTinChi, MaCN, NamHoc
    FROM ChuongTrinhDaoTao ctdt
    WHERE TenCTDT LIKE N'%' + @Keyword + '%'
       OR NamHoc LIKE N'%' + @Keyword + '%'
    ORDER BY ctdt.MaCTDT DESC;
END;
GO

-- 7) Thêm học phần (MaCTDT BIGINT, TienQuyet có thể là MaHP => BIGINT)
CREATE OR ALTER PROCEDURE sp_AddHocPhan
    @TenHP NVARCHAR(150),
    @SoTinChi INT,
    @TietLT INT,
    @TietTH INT,
    @MaCTDT BIGINT,
    @TienQuyet BIGINT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @countHP INT = (SELECT COUNT(*) FROM HocPhan WHERE MaCTDT = @MaCTDT);
    IF @countHP >= 10
    BEGIN
        RAISERROR('CTDT da co 10 hoc phan. Khong the them.',16,1);
        RETURN;
    END

    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT = @MaCTDT AND TenHP = @TenHP)
    BEGIN
        RAISERROR('Ten hoc phan da ton tai trong CTDT.',16,1);
        RETURN;
    END

    -- Sinh MaHP theo quy tac: MaHP = MaCTDT * 100 + seq (seq = max(seq) + 1)
    DECLARE @maxHP BIGINT;
    SELECT @maxHP = MAX(MaHP) FROM HocPhan WHERE MaCTDT = @MaCTDT;

    DECLARE @seq INT = CASE WHEN @maxHP IS NULL THEN 1 ELSE CONVERT(INT, @maxHP % 100) + 1 END;
    IF @seq > 99
    BEGIN
        RAISERROR('Da vuot so luong hoc phan (seq > 99) trong CTDT.',16,1);
        RETURN;
    END

    DECLARE @MaHP BIGINT = @MaCTDT * 100 + @seq;

    INSERT INTO HocPhan (MaHP, TenHP, SoTinChi, TietLT, TietTH, MaCTDT, TienQuyet)
    VALUES (@MaHP, @TenHP, @SoTinChi, @TietLT, @TietTH, @MaCTDT, @TienQuyet);
END;
GO

-- 8) Xóa học phần theo MaHP (BIGINT)
CREATE OR ALTER PROCEDURE sp_DeleteHocPhan
    @MaHP BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM LopHocPhan WHERE MaHP = @MaHP)
    BEGIN
        RAISERROR('Khong the xoa: hoc phan dang co lop hoc phan tham chieu!', 16, 1);
        RETURN;
    END

    DELETE FROM HocPhan WHERE MaHP = @MaHP;
END;
GO

-- 9) Lấy học phần theo ID
CREATE OR ALTER PROCEDURE sp_GetHocPhanById
    @MaHP BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan
    WHERE MaHP = @MaHP;
END;
GO

-- 10) Lấy danh sách học phần
CREATE OR ALTER PROCEDURE sp_GetAllHocPhan
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan;
END;
GO

-- 11) Tìm kiếm học phần theo keyword
CREATE OR ALTER PROCEDURE sp_SearchHocPhanByKeyword
    @Keyword NVARCHAR(150)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan
    WHERE TenHP LIKE '%' + @Keyword + '%';
END;
GO

-- 12) Cập nhật học phần (cùng ràng buộc)
CREATE OR ALTER PROCEDURE sp_UpdateHocPhan
    @MaHP BIGINT,
    @TenHP NVARCHAR(150),
    @SoTinChi INT,
    @TietLT INT,
    @TietTH INT,
    @MaCTDT BIGINT,
    @TienQuyet BIGINT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT = @MaCTDT AND TenHP = @TenHP AND MaHP <> @MaHP)
    BEGIN
        RAISERROR('Ten hoc phan da ton tai trong CTDT.',16,1);
        RETURN;
    END

    UPDATE HocPhan
    SET TenHP = @TenHP,
        SoTinChi = @SoTinChi,
        TietLT = @TietLT,
        TietTH = @TietTH,
        MaCTDT = @MaCTDT,
        TienQuyet = @TienQuyet
    WHERE MaHP = @MaHP;
END;
GO

-- 13) Phân công giảng dạy (Kiểm tra xung đột tiết dựa trên LichHoc.TietBatDau & SoTiet)
CREATE OR ALTER PROCEDURE sp_AssignGiangDay
    @MaGV INT,
    @MaLHP BIGINT,
    @SoTietPhanCong INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Kiểm tra tồn tại LHP
    IF NOT EXISTS (SELECT 1 FROM LopHocPhan WHERE MaLHP = @MaLHP)
    BEGIN
        RAISERROR('Lop hoc phan khong ton tai.',16,1);
        RETURN;
    END

    -- Kiểm tra xung đột: giang vien da co lop o tiet trung gian
    IF EXISTS (
        SELECT 1
        FROM GiangDay GD
        JOIN LichHoc LH1 ON GD.MaLHP = LH1.MaLHP
        JOIN LichHoc LH2 ON LH2.MaLHP = @MaLHP
        WHERE GD.MaGV = @MaGV
          AND (
              (LH1.TietBatDau <= LH2.TietBatDau + LH2.SoTiet - 1)
              AND (LH1.TietBatDau + LH1.SoTiet - 1 >= LH2.TietBatDau)
          )
    )
    BEGIN
        RAISERROR('Giao vien da duoc phan cong o cung tiet.',16,1);
        RETURN;
    END

    IF EXISTS (SELECT 1 FROM GiangDay WHERE MaGV = @MaGV AND MaLHP = @MaLHP)
        UPDATE GiangDay SET SoTietPhanCong = @SoTietPhanCong WHERE MaGV = @MaGV AND MaLHP = @MaLHP;
    ELSE
        INSERT INTO GiangDay (MaGV, MaLHP, SoTietPhanCong) VALUES (@MaGV, @MaLHP, @SoTietPhanCong);
END;
GO

-- 14) Thêm lịch thi (MaLHP BIGINT, MaPH INT)
CREATE OR ALTER PROCEDURE sp_AddLichThi
    @MaLHP BIGINT,
    @NgayThi DATE,
    @GioThi TIME,
    @MaPH INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Kiem tra phong da co lich thi tai thoi diem nay
    IF EXISTS (SELECT 1 FROM LichThi WHERE MaPH = @MaPH AND NgayThi = @NgayThi AND GioThi = @GioThi)
    BEGIN
        RAISERROR('Phong da co lich thi tai thoi diem nay.',16,1);
        RETURN;
    END

    -- Kiem tra xung dot giang vien (nhung giang vien day lop @MaLHP)
    IF EXISTS (
        SELECT 1
        FROM GiangDay GD
        JOIN LichThi LT ON GD.MaLHP = LT.MaLHP
        WHERE GD.MaGV IN (SELECT MaGV FROM GiangDay WHERE MaLHP = @MaLHP)
          AND LT.NgayThi = @NgayThi
          AND LT.GioThi = @GioThi
    )
    BEGIN
        RAISERROR('Giao vien bi xung dot lich thi.',16,1);
        RETURN;
    END

    INSERT INTO LichThi (MaLHP, NgayThi, GioThi, MaPH) VALUES (@MaLHP, @NgayThi, @GioThi, @MaPH);
END;
GO

-- 15) Nhập điểm lần thi (MaSV & MaHP là BIGINT)
CREATE OR ALTER PROCEDURE sp_AddChiTietDiem
    @MaSV BIGINT,
    @MaHP BIGINT,
    @LanThi INT,
    @DiemCC DECIMAL(3,1),
    @DiemGK DECIMAL(3,1),
    @DiemCK DECIMAL(3,1)
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO ChiTietDiem (MaSV, MaHP, LanThi, DiemCC, DiemGK, DiemCK)
    VALUES (@MaSV, @MaHP, @LanThi, @DiemCC, @DiemGK, @DiemCK);

    -- Cap nhat ket qua tong ket theo cong thuc va xep loai
    DECLARE @TongKet DECIMAL(3,1) = ROUND(@DiemCC * 0.1 + @DiemGK * 0.3 + @DiemCK * 0.6, 1);

    IF EXISTS (SELECT 1 FROM KetQuaTongKet WHERE MaSV = @MaSV AND MaHP = @MaHP)
    BEGIN
        UPDATE KetQuaTongKet
        SET TongKet = @TongKet,
            XepLoai = CASE
                        WHEN @TongKet >= 8 THEN N'Gioi'
                        WHEN @TongKet >= 6.5 THEN N'Kha'
                        WHEN @TongKet >= 5 THEN N'Trung binh'
                        ELSE N'Yeu'
                      END
        WHERE MaSV = @MaSV AND MaHP = @MaHP;
    END
    ELSE
    BEGIN
        INSERT INTO KetQuaTongKet (MaSV, MaHP, TongKet, XepLoai)
        VALUES (@MaSV, @MaHP, @TongKet,
               CASE
                 WHEN @TongKet >= 8 THEN N'Gioi'
                 WHEN @TongKet >= 6.5 THEN N'Kha'
                 WHEN @TongKet >= 5 THEN N'Trung binh'
                 ELSE N'Yeu'
               END);
    END
END;
GO

-- 16) Bao cao mon chua dat (MaSV BIGINT)
CREATE OR ALTER PROCEDURE sp_BaoCaoMonChuaDat
    @MaSV BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT HP.TenHP, KD.TongKet, KD.XepLoai, CD.LanThi
    FROM KetQuaTongKet KD
    JOIN ChiTietDiem CD ON KD.MaSV = CD.MaSV AND KD.MaHP = CD.MaHP
    JOIN HocPhan HP ON KD.MaHP = HP.MaHP
    WHERE KD.MaSV = @MaSV AND KD.TongKet < 5
    ORDER BY HP.TenHP, CD.LanThi DESC;
END;
GO

-- 17) Lấy tất cả tài khoản
CREATE OR ALTER PROCEDURE sp_GetAllTaiKhoan
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM TaiKhoan;
END;
GO

-- 18) Check login
CREATE OR ALTER PROCEDURE sp_CheckLogin
    @TenDangNhap NVARCHAR(50),
    @MatKhau NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaTK, TenDangNhap, LoaiTaiKhoan, MaSV, MaNV
    FROM TaiKhoan
    WHERE TenDangNhap = @TenDangNhap AND MatKhau = @MatKhau;
END;
GO

-- 19) Thêm Khoa
CREATE OR ALTER PROCEDURE sp_AddKhoa
    @TenKhoa NVARCHAR(100),
    @Email NVARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO Khoa (TenKhoa, Email) VALUES (@TenKhoa, @Email);
END;
GO

-- 20) Sửa Khoa
CREATE OR ALTER PROCEDURE sp_UpdateKhoa
    @MaKhoa INT,
    @TenKhoa NVARCHAR(100),
    @Email NVARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;
    UPDATE Khoa SET TenKhoa = @TenKhoa, Email = @Email WHERE MaKhoa = @MaKhoa;
END;
GO

-- 21) Xóa Khoa
CREATE OR ALTER PROCEDURE sp_DeleteKhoa
    @MaKhoa INT
AS
BEGIN
    SET NOCOUNT ON;
    DELETE FROM Khoa WHERE MaKhoa = @MaKhoa;
END;
GO

-- 22) Lấy tất cả Khoa
CREATE OR ALTER PROCEDURE sp_GetAllKhoa
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM Khoa;
END;
GO

-- 23) Lấy Khoa theo ID
CREATE OR ALTER PROCEDURE sp_GetKhoaById
    @MaKhoa INT
AS
BEGIN
    SET NOCOUNT ON;
    SELECT * FROM Khoa WHERE MaKhoa = @MaKhoa;
END;
GO

-- 24) Search Khoa
CREATE OR ALTER PROCEDURE sp_SearchKhoa
    @keyword NVARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaKhoa, TenKhoa, Email
    FROM Khoa
    WHERE (@keyword IS NULL OR @keyword = '')
       OR (TenKhoa LIKE '%' + @keyword + '%' OR Email LIKE '%' + @keyword + '%')
    ORDER BY MaKhoa;
END;
GO

-- 25) Lấy người quản lý CTDT (MaCTDT BIGINT)
CREATE OR ALTER PROCEDURE sp_GetQuanLyCTDT
    @MaCTDT BIGINT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        ctdt.MaCTDT,
        ctdt.TenCTDT,
        nv.MaNV,
        nv.HoTen,
        nv.HocVi,
        nv.VaiTro,
        nv.Email
    FROM CTDT_NhanVien ctdt_nv
    INNER JOIN NhanVien nv ON ctdt_nv.MaNV = nv.MaNV
    INNER JOIN ChuongTrinhDaoTao ctdt ON ctdt_nv.MaCTDT = ctdt.MaCTDT
    WHERE ctdt.MaCTDT = @MaCTDT;
END;
GO

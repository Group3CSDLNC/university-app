USE [QuanLyTrungTamDaoTaoD];
GO

-- Thêm chương trình
CREATE PROCEDURE sp_AddChuongTrinh
    @TenCTDT NVARCHAR(150),
    @TongTinChi INT,
    @MaCN INT,
    @NamHoc NVARCHAR(50)
AS
BEGIN
    INSERT INTO ChuongTrinhDaoTao (TenCTDT, TongTinChi, MaCN, NamHoc)
    VALUES (@TenCTDT, @TongTinChi, @MaCN, @NamHoc);
END
GO

-- Cập nhật chương trình
CREATE PROCEDURE sp_UpdateChuongTrinh
    @MaCTDT INT,
    @TenCTDT NVARCHAR(150),
    @TongTinChi INT,
    @MaCN INT,
    @NamHoc NVARCHAR(50)
AS
BEGIN
    UPDATE ChuongTrinhDaoTao
    SET TenCTDT=@TenCTDT, TongTinChi=@TongTinChi, MaCN=@MaCN, NamHoc=@NamHoc
    WHERE MaCTDT=@MaCTDT;
END
GO

-- Xóa chương trình (kiểm tra ràng buộc)
CREATE PROCEDURE sp_DeleteChuongTrinh
    @MaCTDT INT
AS
BEGIN
    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT=@MaCTDT)
       OR EXISTS (SELECT 1 FROM LopHocPhan LHP
                  JOIN HocPhan HP ON LHP.MaHP=HP.MaHP
                  WHERE HP.MaCTDT=@MaCTDT)
    BEGIN
        RAISERROR('Khong the xoa CTDT vi ton tai hoc phan hoac lop hoc phan lien quan.',16,1)
        RETURN
    END

    DELETE FROM ChuongTrinhDaoTao WHERE MaCTDT=@MaCTDT;
END
GO

-- Gán nhân viên quản lý chương trình
CREATE PROCEDURE sp_AssignNVQuanLyCTDT
    @MaCTDT INT,
    @MaNV INT
AS
BEGIN
    IF EXISTS (SELECT 1 FROM CTDT_NhanVien WHERE MaCTDT=@MaCTDT)
        UPDATE CTDT_NhanVien SET MaNV=@MaNV WHERE MaCTDT=@MaCTDT
    ELSE
        INSERT INTO CTDT_NhanVien(MaCTDT, MaNV) VALUES(@MaCTDT,@MaNV)
END
GO

-- Danh sách + filter
CREATE PROCEDURE sp_ListCTDT
    @MaKhoa INT = NULL,
    @NamHoc NVARCHAR(50) = NULL,
    @MaNVQuanLy INT = NULL
AS
BEGIN
    SELECT CT.*, CN.TenCN, NV.HoTen AS NguoiQuanLy
    FROM ChuongTrinhDaoTao CT
    JOIN ChuyenNganh CN ON CT.MaCN=CN.MaCN
    LEFT JOIN CTDT_NhanVien NVCT ON CT.MaCTDT=NVCT.MaCTDT
    LEFT JOIN NhanVien NV ON NVCT.MaNV=NV.MaNV
    WHERE (@MaKhoa IS NULL OR CN.MaKhoa=@MaKhoa)
      AND (@NamHoc IS NULL OR CT.NamHoc=@NamHoc)
      AND (@MaNVQuanLy IS NULL OR NV.MaNV=@MaNVQuanLy)
END
GO

-- Search CTDT theo keyword (tên hoặc năm học)

CREATE OR ALTER PROCEDURE sp_SearchCTDT
    @Keyword NVARCHAR(255)
AS
BEGIN
    SET NOCOUNT ON;
    SELECT MaCTDT, TenCTDT, TongTinChi, MaCN, NamHoc
    FROM ChuongTrinhDaoTao
    WHERE TenCTDT LIKE N'%' + @Keyword + '%'
       OR NamHoc LIKE N'%' + @Keyword + '%';
END
GO

-- Thêm học phần
CREATE PROCEDURE sp_AddHocPhan
    @TenHP NVARCHAR(150),
    @SoTinChi INT,
    @TietLT INT,
    @TietTH INT,
    @MaCTDT INT,
    @TienQuyet INT
AS
BEGIN
    -- Kiểm tra số lượng học phần trong CTDT <=10
    DECLARE @countHP INT
    SELECT @countHP=COUNT(*) FROM HocPhan WHERE MaCTDT=@MaCTDT
    IF @countHP >= 10
    BEGIN
        RAISERROR('CTDT da co 10 hoc phan. Khong the them.',16,1)
        RETURN
    END

    -- Kiểm tra tên học phần trùng trong cùng CTDT
    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT=@MaCTDT AND TenHP=@TenHP)
    BEGIN
        RAISERROR('Ten hoc phan da ton tai trong CTDT.',16,1)
        RETURN
    END

    INSERT INTO HocPhan (TenHP, SoTinChi, TietLT, TietTH, MaCTDT, TienQuyet)
    VALUES (@TenHP,@SoTinChi,@TietLT,@TietTH,@MaCTDT,@TienQuyet)
END
GO

-- ===============================
-- Xóa học phần
-- ===============================
CREATE PROCEDURE sp_DeleteHocPhan
    @MaHP INT
AS
BEGIN
    DELETE FROM HocPhan
    WHERE MaHP = @MaHP;
END
GO

-- ===============================
-- Lấy học phần theo ID
-- ===============================
CREATE PROCEDURE sp_GetHocPhanById
    @MaHP INT
AS
BEGIN
    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan
    WHERE MaHP = @MaHP;
END
GO

-- ===============================
-- Lấy danh sách học phần
-- ===============================
CREATE PROCEDURE sp_GetAllHocPhan
AS
BEGIN
    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan;
END
GO

-- ===============================
-- Tìm kiếm học phần theo keyword
-- ===============================
CREATE PROCEDURE sp_SearchHocPhanByKeyword
    @Keyword NVARCHAR(150)
AS
BEGIN
    SELECT MaHP, TenHP, SoTinChi, TietTH, TietLT, MaCTDT, TienQuyet
    FROM HocPhan
    WHERE TenHP LIKE '%' + @Keyword + '%';
END
GO
-- =======================
-- XÓA HỌC PHẦN AN TOÀN
-- =======================
CREATE PROCEDURE HocPhan_Delete
    @MaHP INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Kiểm tra FK
    IF EXISTS (SELECT 1 FROM LopHocPhan WHERE MaHP = @MaHP)
    BEGIN
        -- Không xóa, trả thông báo lỗi
        RAISERROR('Không thể xóa: học phần đang có lớp học phần tham chiếu!', 16, 1);
        RETURN;
    END

    -- Xóa học phần
    DELETE FROM hocphan WHERE MaHP = @MaHP;
END;
GO

-- Cập nhật học phần (cùng ràng buộc)
CREATE PROCEDURE sp_UpdateHocPhan
    @MaHP INT,
    @TenHP NVARCHAR(150),
    @SoTinChi INT,
    @TietLT INT,
    @TietTH INT,
    @MaCTDT INT,
    @TienQuyet INT
AS
BEGIN
    IF EXISTS (SELECT 1 FROM HocPhan WHERE MaCTDT=@MaCTDT AND TenHP=@TenHP AND MaHP<>@MaHP)
    BEGIN
        RAISERROR('Ten hoc phan da ton tai trong CTDT.',16,1)
        RETURN
    END

    UPDATE HocPhan
    SET TenHP=@TenHP, SoTinChi=@SoTinChi, TietLT=@TietLT, TietTH=@TietTH,
        MaCTDT=@MaCTDT, TienQuyet=@TienQuyet
    WHERE MaHP=@MaHP
END
GO

CREATE PROCEDURE sp_AssignGiangDay
    @MaGV INT,
    @MaLHP VARCHAR(10),
    @SoTietPhanCong INT
AS
BEGIN
    -- Kiểm tra xung đột: giảng viên không dạy 2 lớp cùng tiết
    IF EXISTS (
        SELECT 1
        FROM GiangDay GD
        JOIN LopHocPhan LHP1 ON GD.MaLHP=LHP1.MaLHP
        JOIN LichHoc LH ON LH.MaLHP=LHP1.MaLHP
        JOIN LopHocPhan LHP2 ON LHP2.MaLHP=@MaLHP
        JOIN LichHoc LH2 ON LH2.MaLHP=LHP2.MaLHP
        WHERE GD.MaGV=@MaGV AND LH.Ngay=LH2.Ngay AND LH.MaPH=LH2.MaPH
    )
    BEGIN
        RAISERROR('Giao vien da duoc phan cong o cung tiet.',16,1)
        RETURN
    END

    IF EXISTS (SELECT 1 FROM GiangDay WHERE MaGV=@MaGV AND MaLHP=@MaLHP)
        UPDATE GiangDay SET SoTietPhanCong=@SoTietPhanCong WHERE MaGV=@MaGV AND MaLHP=@MaLHP
    ELSE
        INSERT INTO GiangDay(MaGV, MaLHP, SoTietPhanCong) VALUES(@MaGV,@MaLHP,@SoTietPhanCong)
END
GO


CREATE PROCEDURE sp_AddLichThi
    @MaLHP VARCHAR(10),
    @NgayThi DATE,
    @GioThi TIME,
    @MaPH VARCHAR(10)
AS
BEGIN
    -- Kiểm tra xung đột phòng
    IF EXISTS (SELECT 1 FROM LichThi WHERE MaPH=@MaPH AND NgayThi=@NgayThi AND GioThi=@GioThi)
    BEGIN
        RAISERROR('Phong da co lich thi tai thoi diem nay.',16,1)
        RETURN
    END

    -- Kiểm tra xung đột giang vien
    IF EXISTS (
        SELECT 1
        FROM GiangDay GD
        JOIN LichThi LT ON GD.MaLHP=LT.MaLHP
        WHERE GD.MaGV IN (SELECT MaGV FROM GiangDay WHERE MaLHP=@MaLHP)
          AND LT.NgayThi=@NgayThi AND LT.GioThi=@GioThi
    )
    BEGIN
        RAISERROR('Giao vien bi xung dot lich thi.',16,1)
        RETURN
    END

    INSERT INTO LichThi(MaLHP, NgayThi, GioThi, MaPH) VALUES(@MaLHP,@NgayThi,@GioThi,@MaPH)
END
GO

-- Nhập điểm lần thi
CREATE PROCEDURE sp_AddChiTietDiem
    @MaSV INT,
    @MaHP INT,
    @LanThi INT,
    @DiemCC DECIMAL(3,1),
    @DiemGK DECIMAL(3,1),
    @DiemCK DECIMAL(3,1)
AS
BEGIN
    INSERT INTO ChiTietDiem(MaSV, MaHP, LanThi, DiemCC, DiemGK, DiemCK)
    VALUES(@MaSV,@MaHP,@LanThi,@DiemCC,@DiemGK,@DiemCK);

    -- Cập nhật tong ket
    DECLARE @TongKet DECIMAL(3,1)
    SELECT @TongKet=ROUND(@DiemCC*0.1 + @DiemGK*0.3 + @DiemCK*0.6,1)

    IF EXISTS (SELECT 1 FROM KetQuaTongKet WHERE MaSV=@MaSV AND MaHP=@MaHP)
        UPDATE KetQuaTongKet SET TongKet=@TongKet,
            XepLoai=CASE WHEN @TongKet>=8 THEN 'Gioi'
                          WHEN @TongKet>=6.5 THEN 'Kha'
                          WHEN @TongKet>=5 THEN 'Trung binh'
                          ELSE 'Yeu' END
        WHERE MaSV=@MaSV AND MaHP=@MaHP
    ELSE
        INSERT INTO KetQuaTongKet(MaSV, MaHP, TongKet, XepLoai)
        VALUES(@MaSV,@MaHP,@TongKet,
               CASE WHEN @TongKet>=8 THEN 'Gioi'
                    WHEN @TongKet>=6.5 THEN 'Kha'
                    WHEN @TongKet>=5 THEN 'Trung binh'
                    ELSE 'Yeu' END)
END
GO

CREATE PROCEDURE sp_BaoCaoMonChuaDat
    @MaSV INT
AS
BEGIN
    SELECT HP.TenHP, KD.TongKet, KD.XepLoai, CD.LanThi
    FROM KetQuaTongKet KD
    JOIN ChiTietDiem CD ON KD.MaSV=CD.MaSV AND KD.MaHP=CD.MaHP
    JOIN HocPhan HP ON KD.MaHP=HP.MaHP
    WHERE KD.MaSV=@MaSV AND KD.TongKet<5
    ORDER BY HP.TenHP, CD.LanThi DESC
END
GO


CREATE PROCEDURE [sp_GetAllTaiKhoan]
AS
BEGIN
    SET NOCOUNT ON;
    SELECT *
    FROM taikhoan
END

CREATE PROCEDURE sp_CheckLogin
    @TenDangNhap NVARCHAR(50),
    @MatKhau NVARCHAR(50)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT MaTK, TenDangNhap, LoaiTaiKhoan, MaSV, MaNV
    FROM TaiKhoan
    WHERE TenDangNhap = @TenDangNhap AND MatKhau = @MatKhau;
END;
GO
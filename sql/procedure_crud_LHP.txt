CREATE OR ALTER PROCEDURE sp_AddLopHocPhan
    @MaHP INT,
    @HocKy INT,
    @NamHoc VARCHAR(9),
    @MaCTDT INT,
    @SiSo INT
AS
BEGIN
    SET NOCOUNT ON;

    -- Tạo sequence
    DECLARE @Seq INT;
    SELECT @Seq = ISNULL(MAX(CAST(RIGHT(MaLHP,3) AS INT)),0) + 1
    FROM LopHocPhan
    WHERE HocKy = @HocKy AND NamHoc = @NamHoc AND MaHP IN (
        SELECT MaHP FROM HocPhan WHERE MaCTDT = @MaCTDT
    );

    DECLARE @MaLHP VARCHAR(20);
    SET @MaLHP = CONCAT('CT', @MaCTDT, '_', @HocKy, '_', @NamHoc, '_', FORMAT(@Seq,'000'));

    INSERT INTO LopHocPhan (MaLHP, MaHP, HocKy, NamHoc, SiSo)
    VALUES (@MaLHP, @MaHP, @HocKy, @NamHoc, @SiSo);

    SELECT @MaLHP AS MaLHP;
END;

CREATE OR ALTER PROCEDURE sp_UpdateLopHocPhan
    @MaLHP VARCHAR(20),
    @HocKy INT,
    @NamHoc VARCHAR(9),
    @SiSo INT
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM LopHocPhan WHERE MaLHP = @MaLHP)
        THROW 51001, 'Lớp học phần không tồn tại', 1;

    UPDATE LopHocPhan
    SET HocKy = @HocKy, NamHoc = @NamHoc, SiSo = @SiSo
    WHERE MaLHP = @MaLHP;
END;

CREATE OR ALTER PROCEDURE sp_DeleteLopHocPhan
    @MaLHP VARCHAR(20)
AS
BEGIN
    IF NOT EXISTS (SELECT 1 FROM LopHocPhan WHERE MaLHP = @MaLHP)
        THROW 51001, 'Lớp học phần không tồn tại', 1;

    DELETE FROM LopHocPhan WHERE MaLHP = @MaLHP;
END;

CREATE OR ALTER PROCEDURE sp_GetLopHocPhan
    @HocKy INT = NULL,
    @NamHoc VARCHAR(9) = NULL,
    @MaCTDT INT = NULL,
    @MaGV INT = NULL
AS
BEGIN
    SELECT lhp.MaLHP, hp.TenHP, lhp.HocKy, lhp.NamHoc, lhp.SiSo
    FROM LopHocPhan lhp
    JOIN HocPhan hp ON lhp.MaHP = hp.MaHP
    LEFT JOIN GiangDay gd ON lhp.MaLHP = gd.MaLHP
    WHERE (@HocKy IS NULL OR lhp.HocKy = @HocKy)
      AND (@NamHoc IS NULL OR lhp.NamHoc = @NamHoc)
      AND (@MaCTDT IS NULL OR hp.MaCTDT = @MaCTDT)
      AND (@MaGV IS NULL OR gd.MaGV = @MaGV);
END;

CREATE OR ALTER PROCEDURE sp_GetLopHocPhanBySV
    @MaSV   INT,
    @NamHoc NVARCHAR(9),
    @HocKy  INT,
    @MaCN   INT = NULL   -- tham số lọc chuyên ngành (có thể NULL = bỏ lọc)
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        lhp.MaLHP,
        hp.MaHP,
        hp.TenHP,
        hp.SoTinChi,
        hp.TietLT,
        hp.TietTH,
        lhp.SiSo AS SiSoToiDa,
        COUNT(DISTINCT dk.MaSV) AS SoLuongDaDangKy,
        (lhp.SiSo - COUNT(DISTINCT dk.MaSV)) AS SlotConLai,
        lhp.NamHoc,
        lhp.HocKy,
        MIN(ph.SoPhong) AS PhongHoc,             -- phòng học đại diện
        MIN(lh.Ngay) AS NgayBatDau,              -- ngày bắt đầu môn học
        MIN(lh.SoTiet) AS TietBatDau,            -- tiết học bắt đầu
        gv.HoTen AS GiangVienChinh,
        STRING_AGG(tg.HoTen, ', ') AS TroGiang,
        cn.TenCN AS TenChuyenNganh,
        ctdt.TenCTDT AS TenChuongTrinhDaoTao,
        CASE WHEN dk_sv.MaSV IS NOT NULL THEN 1 ELSE 0 END AS IsDangKy -- đã đăng ký chưa
    FROM LopHocPhan lhp
    JOIN HocPhan hp ON lhp.MaHP = hp.MaHP
    JOIN ChuongTrinhDaoTao ctdt ON hp.MaCTDT = ctdt.MaCTDT
    JOIN ChuyenNganh cn ON ctdt.MaCN = cn.MaCN
    LEFT JOIN GiangDay gd ON gd.MaLHP = lhp.MaLHP
    LEFT JOIN NhanVien gv ON gd.MaGV = gv.MaNV
    LEFT JOIN GiangVien_TroGiang gvtg ON gvtg.MaHP = hp.MaHP
    LEFT JOIN NhanVien tg ON gvtg.MaGV_TroGiang = tg.MaNV
    LEFT JOIN LichHoc lh ON lh.MaLHP = lhp.MaLHP
    LEFT JOIN PhongHoc ph ON lh.MaPH = ph.MaPH
    LEFT JOIN DangKy dk ON dk.MaLHP = lhp.MaLHP
    LEFT JOIN DangKy dk_sv ON dk_sv.MaLHP = lhp.MaLHP AND dk_sv.MaSV = @MaSV -- check đã đăng ký
    WHERE lhp.NamHoc = @NamHoc
      AND lhp.HocKy = @HocKy
      AND (@MaCN IS NULL OR ctdt.MaCN = @MaCN)
    GROUP BY lhp.MaLHP, hp.MaHP, hp.TenHP, hp.SoTinChi, hp.TietLT, hp.TietTH,
             lhp.SiSo, lhp.NamHoc, lhp.HocKy, gv.HoTen, cn.TenCN, ctdt.TenCTDT, dk_sv.MaSV
    ORDER BY lhp.MaLHP;
END;
GO


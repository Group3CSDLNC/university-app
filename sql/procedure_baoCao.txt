CREATE OR ALTER PROCEDURE [dbo].[sp_BangDiemSinhVien]
    @MaSV   BIGINT = NULL,
    @MaCTDT BIGINT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        sv.MaSV,
        sv.HoTen,
        ctdt.MaCTDT,
        ctdt.TenCTDT,
        ctdt.NamHoc,
        hp.MaHP,
        hp.TenHP,
        kq.TongKet,
        kq.XepLoai,
        ct.LanThi,
        ct.DiemCC,
        ct.DiemGK,
        ct.DiemCK,
        CASE
            WHEN ct.DiemCC IS NOT NULL OR ct.DiemGK IS NOT NULL OR ct.DiemCK IS NOT NULL
            THEN (ISNULL(ct.DiemCC,0) * 0.1 + ISNULL(ct.DiemGK,0) * 0.3 + ISNULL(ct.DiemCK,0) * 0.6)
            ELSE NULL
        END AS TongKet_TuChiTiet,
        CASE
            WHEN kq.TongKet >= 5 THEN 'Pass'
            ELSE 'Fail'
        END AS TrangThai
    FROM SinhVien sv
    JOIN ChuyenNganh cn ON sv.MaCN = cn.MaCN
    JOIN ChuongTrinhDaoTao ctdt ON ctdt.MaCN = cn.MaCN
    JOIN HocPhan hp ON hp.MaCTDT = ctdt.MaCTDT
    JOIN KetQuaTongKet kq ON kq.MaSV = sv.MaSV AND kq.MaHP = hp.MaHP
    OUTER APPLY
    (
        SELECT TOP (1)
            cd.LanThi,
            cd.DiemCC,
            cd.DiemGK,
            cd.DiemCK
        FROM ChiTietDiem cd
        WHERE cd.MaSV = sv.MaSV
          AND cd.MaHP = hp.MaHP
        ORDER BY cd.LanThi DESC
    ) ct
    WHERE
        (@MaSV IS NULL OR sv.MaSV = @MaSV)
        AND (@MaCTDT IS NULL OR ctdt.MaCTDT = @MaCTDT)
    ORDER BY sv.MaSV, ctdt.MaCTDT, hp.MaHP
END
GO   -- <== THÊM DÒNG NÀY


CREATE OR ALTER PROCEDURE [dbo].[sp_SinhVienChuaHoanThanhKhoa]
    @MaSV   BIGINT = NULL,
    @MaCTDT BIGINT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    ;WITH KetQua AS (
        SELECT
            sv.MaSV,
            sv.HoTen,
            ctdt.MaCTDT,
            ctdt.TenCTDT,
            ctdt.NamHoc,
            hp.MaHP,
            hp.TenHP,
            ctDiem.LanThi,
            ctDiem.DiemCC,
            ctDiem.DiemGK,
            ctDiem.DiemCK,
            (ISNULL(ctDiem.DiemCC,0)*0.1
             + ISNULL(ctDiem.DiemGK,0)*0.3
             + ISNULL(ctDiem.DiemCK,0)*0.6) AS TongKet
        FROM SinhVien sv
        JOIN ChuyenNganh cn ON sv.MaCN = cn.MaCN
        JOIN ChuongTrinhDaoTao ctdt ON ctdt.MaCN = cn.MaCN
        JOIN HocPhan hp ON hp.MaCTDT = ctdt.MaCTDT
        LEFT JOIN ChiTietDiem ctDiem
               ON ctDiem.MaSV = sv.MaSV AND ctDiem.MaHP = hp.MaHP
        WHERE (@MaSV IS NULL OR sv.MaSV = @MaSV)
          AND (@MaCTDT IS NULL OR ctdt.MaCTDT = @MaCTDT)
    )
    SELECT
        kq.MaSV,
        kq.HoTen,
        kq.MaCTDT,
        kq.TenCTDT,
        kq.NamHoc,
        kq.MaHP,
        kq.TenHP,
        kq.LanThi,
        kq.DiemCC,
        kq.DiemGK,
        kq.DiemCK,
        kq.TongKet,
        CASE
            WHEN kq.TongKet >= 5 THEN 'Pass'
            ELSE 'Fail'
        END AS TrangThai
    FROM KetQua kq
    WHERE kq.MaSV IN (
        SELECT MaSV
        FROM KetQua
        GROUP BY MaSV, MaCTDT
        HAVING COUNT(CASE WHEN TongKet >= 5 THEN 1 END)
               < (SELECT COUNT(*) FROM HocPhan WHERE MaCTDT = KetQua.MaCTDT)
    )
      AND (kq.TongKet < 5 OR kq.TongKet IS NULL)
    ORDER BY kq.MaSV, kq.MaCTDT, kq.MaHP, kq.LanThi;
END
GO   -- <== THÊM DÒNG NÀY


CREATE OR ALTER PROCEDURE sp_BaoCaoSiSoLop
AS
BEGIN
    SET NOCOUNT ON;

    -- Báo cáo sĩ số
    SELECT
        lhp.MaLHP,
        hp.TenHP,
        COUNT(dk.MaSV) AS SiSoThucTe,
        lhp.SiSo AS SiSoToiDa,
        ph.SoPhong,
        ph.SucChua,
        CASE WHEN COUNT(dk.MaSV) > ph.SucChua THEN N'Vượt sức chứa' ELSE N'OK' END AS TrangThaiPhong
    FROM LopHocPhan lhp
    JOIN HocPhan hp ON lhp.MaHP = hp.MaHP
    LEFT JOIN DangKy dk ON dk.MaLHP = lhp.MaLHP
    LEFT JOIN LichHoc lh ON lh.MaLHP = lhp.MaLHP
    LEFT JOIN PhongHoc ph ON lh.MaPH = ph.MaPH
    GROUP BY lhp.MaLHP, hp.TenHP, lhp.SiSo, ph.SoPhong, ph.SucChua;

    -- Kiểm tra lịch trùng
    SELECT DISTINCT
        lh1.MaLHP AS MaLHP1,
        lh2.MaLHP AS MaLHP2,
        lh1.MaPH,
        ph.SoPhong,
        lh1.ThuTrongTuan,
        lh1.TietBatDau AS TietBatDau1,
        lh1.SoTiet AS SoTiet1,
        lh2.TietBatDau AS TietBatDau2,
        lh2.SoTiet AS SoTiet2,
        lh1.NgayBatDau,
        lh1.NgayKetThuc,
        lh2.NgayBatDau AS NgayBatDau2,
        lh2.NgayKetThuc AS NgayKetThuc2
    FROM LichHoc lh1
    JOIN LichHoc lh2
        ON lh1.MaPH = lh2.MaPH
        AND lh1.MaLHP <> lh2.MaLHP
        AND lh1.ThuTrongTuan = lh2.ThuTrongTuan
        AND lh1.NgayBatDau <= lh2.NgayKetThuc
        AND lh1.NgayKetThuc >= lh2.NgayBatDau
        AND (lh1.TietBatDau BETWEEN lh2.TietBatDau AND (lh2.TietBatDau + lh2.SoTiet - 1)
             OR lh2.TietBatDau BETWEEN lh1.TietBatDau AND (lh1.TietBatDau + lh1.SoTiet - 1))
    LEFT JOIN PhongHoc ph ON lh1.MaPH = ph.MaPH
    ORDER BY lh1.MaPH, lh1.ThuTrongTuan, lh1.TietBatDau;
END
GO
